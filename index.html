<html>
	<head>
	  	<style>
			* {
				margin: 0;
			}
		</style>
		<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyDqEzyD2efs_DOhLZZiOquT4uglQE3h2JA",
				authDomain: "onlinegame-7c1a9.firebaseapp.com",
				databaseURL: "https://onlinegame-7c1a9.firebaseio.com",
				projectId: "onlinegame-7c1a9",
				storageBucket: "",
				messagingSenderId: "1049193125210"
			};
			firebase.initializeApp(config);
		</script>
		<script>
			var dimension = [document.documentElement.clientWidth, document.documentElement.clientHeight];
			var user = Math.floor((Math.random() * 10000) + 1);
			var db = firebase.database();
			var clicked = false;
			var mouse = [0,0];
			var click = [0,0];
			var packet = 0;
			
			function animLoop( render, element ) {
				var running, lastFrame = +new Date;
				function loop( now ) {
					// stop the loop if render returned false
					if ( running !== false ) {
						requestAnimationFrame( loop, element );
						var deltaT = now - lastFrame;
						// do not render frame when deltaT is too high
						if ( deltaT < 160 ) {
							running = render( deltaT );
						}
						lastFrame = now;
					}
				}
				loop( lastFrame );
			}
			function events() {
				db.ref('/settings/').on('value', function(value) {
					if(!value.val()["useKeyboard"]) {
						document.addEventListener("mousemove", function(e){
							mouse = [e.pageX, e.pageY];
							packet = 0;
							db.ref("/players/" + user).set({
								packet: 0
							});
							db.ref("/players/" + user + "/packets").set({
								0: clicked,
								1: mouse[0],
								2: mouse[1]
							});
						});
					}else{
						document.addEventListener("keydown", function(e){
							var charCode = e.keyCode || e.which;
							packet = 0;
							
							if(charCode == 40 || charCode == 83) { //DOWN
								mouse[1] += 10;
							}else if(charCode == 38 || charCode == 87) { //UP
								mouse[1] -= 10;
							}else if(charCode == 39 || charCode == 68) { //RIGHT
								mouse[0] += 10;
							}else if(charCode == 37 || charCode == 65) { //LEFT
								mouse[0] -= 10;
							}
							
							db.ref("/players/" + user).set({
								packet: packet
							});
							db.ref("/players/" + user + "/packets").set({
								0: clicked,
								1: mouse[0],
								2: mouse[1]
							});
						});
					}
				});
				
				document.addEventListener("mousedown", function(e){
					clicked = true;
					click = [e.pageX, e.pageY];
					packet = 1;
					db.ref("/players/" + user).set({
						packet: packet
					});
					db.ref("/players/" + user + "/packets").set({
						0: clicked,
						1: click[0],
						2: click[1]
					});
				});
				
				document.addEventListener("mouseup", function(){
					clicked = false;
					packet = 1;
					db.ref("/players/" + user).set({
						packet: packet
					});
					db.ref("/players/" + user + "/packets").set({
						0: clicked
					});
				});
			}
      			function load() {
				var canvas = document.getElementById("game");
        			var ctx = canvas.getContext("2d");
				canvas.width = dimension[0];
				canvas.height = dimension[1];
				loop(canvas, ctx);
				
				events();
			}
			function unload() {
				firebase.database().ref("/players/" + user).remove()
			}
			function loop(canvas, ctx) {
				animLoop(function( deltaT ) {
					ctx.clearRect(0, 0, dimension[0], dimension[1]);
					ctx.fillStyle = "lightblue";
					ctx.fillRect(0,0,dimension[0],dimension[1]);
					
					db.ref("/players").on('value', function(players) {
						for(var player in players.val()) {
							if(player == user)
								continue;
							
							//PACKETS
							if(players.val()[player].packet >= 0 || players.val()[player].packet <= 1) {
								if(players.val()[player].packets[0]) {
									ctx.fillStyle = "red";
									ctx.fillRect(players.val()[player].packets[1], players.val()[player].packets[2], 40, 40);
								}else{
									ctx.fillStyle = "gray";
									ctx.fillRect(players.val()[player].packets[1], players.val()[player].packets[2], 40, 40);
								}
							}
						}
					});
					
					if(!clicked) {
						ctx.fillStyle = "gray";
					}else{
						ctx.fillStyle = "red";
					}
					ctx.fillRect(mouse[0], mouse[1], 40, 40);
				}, canvas);
			}
		</script>
	</head>
	<body onload="load();" onunload="unload();">
		<canvas id="game"></canvas>
	</body>
</html>

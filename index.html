<html>
	<head>
	  	<style>
			* {
				margin: 0;
			}
		</style>
		<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyDqEzyD2efs_DOhLZZiOquT4uglQE3h2JA",
				authDomain: "onlinegame-7c1a9.firebaseapp.com",
				databaseURL: "https://onlinegame-7c1a9.firebaseio.com",
				projectId: "onlinegame-7c1a9",
				storageBucket: "",
				messagingSenderId: "1049193125210"
			};
			firebase.initializeApp(config);
		</script>
		<script>
			var dimension = [document.documentElement.clientWidth, document.documentElement.clientHeight];
			var user = Math.floor((Math.random() * 10000) + 1);
			var clicked = false;
			var mouse = [0,0];
			var click = [0,0];
			
			function animLoop( render, element ) {
				var running, lastFrame = +new Date;
				function loop( now ) {
					// stop the loop if render returned false
					if ( running !== false ) {
						requestAnimationFrame( loop, element );
						var deltaT = now - lastFrame;
						// do not render frame when deltaT is too high
						if ( deltaT < 560 ) {
							running = render( deltaT );
						}
						lastFrame = now;
					}
				}
				loop( lastFrame );
			}
			function events() {
				//Mouse
				document.addEventListener("mousemove", function(e){
					mouse = [e.pageX, e.pageY];
				});
				
				document.addEventListener("mousedown", function(e){
					click = [e.pageX, e.pageY];
					clicked = true;
				});
				
				document.addEventListener("mouseup", function(){
					clicked = false;
				});
				
				//Touch
				document.addEventListener("touchstart", function(){
					mouse = [e.pageX, e.pageY];
					clicked = true;
				});
				
				document.addEventListener("touchstart", function(){
					mouse = [e.pageX, e.pageY];
					clicked = true;
				});
				
				document.addEventListener("touchend", function(){
					mouse = [e.pageX, e.pageY];
					clicked = false;
				});
				
				document.addEventListener("touchcancel", function(){
					mouse = [e.pageX, e.pageY];
					clicked = false;
				});
			}
      			function load() {
				var canvas = document.getElementById("game");
        			var ctx = canvas.getContext("2d");
				canvas.width = dimension[0];
				canvas.height = dimension[1];
				loop(canvas, ctx);
				
				events();
			}
			function unload() {
				firebase.database().ref("/players").remove()
			}
			function loop(canvas, ctx) {
				var db = firebase.database();
				animLoop(function( deltaT ) {
					ctx.clearRect(0, 0, dimension[0], dimension[1]);
					ctx.fillStyle = "lightblue";
					ctx.fillRect(0,0,dimension[0],dimension[1]);
					
					db.ref("/players").once('value').then(function(players) {
						for(var player in players.val()) {
							if(player == user)
								continue;
							
							console.log(player + " " + user);
							
							ctx.fillStyle = "gray";
							ctx.fillRect(players.val()[player].x, players.val()[player].y, 20, 20);
						}
					});

					ctx.fillStyle = "gray";
					ctx.fillRect(mouse[0], mouse[1], 20, 20);

					firebase.database().ref("/players/" + user).set({
						x: mouse[0],
						y: mouse[1]
					  });
				}, canvas);
			}
		</script>
	</head>
	<body onload="load();" onunload="unload();">
		<canvas id="game"></canvas>
	</body>
</html>

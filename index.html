<html>
	<head>
	  	<style>
			* {
				margin: 0;
			}
		</style>
		<script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyDqEzyD2efs_DOhLZZiOquT4uglQE3h2JA",
				authDomain: "onlinegame-7c1a9.firebaseapp.com",
				databaseURL: "https://onlinegame-7c1a9.firebaseio.com",
				projectId: "onlinegame-7c1a9",
				storageBucket: "",
				messagingSenderId: "1049193125210"
			};
			firebase.initializeApp(config);
		</script>
		<script>
			var settings = firebase.database().ref('/settings/').once('value').then(function(snapshot) { return [snapshot.val().grav, snapshot.val().jumpspeed, snapshot.val().walkspeed]; });
			var dimension = [document.documentElement.clientWidth, document.documentElement.clientHeight];
			var user = Math.floor((Math.random() * 10000) + 1);
			var db = firebase.database();
			var clicked = false;
			var click = [0,0];
			var packet = 0;
			
			var hsp = 0;
			var vsp = 0;
			var key_right = 0;
			var key_left = 0;
			var move = 0;
			
			function animLoop( render, element ) {
				var running, lastFrame = +new Date;
				function loop( now ) {
					// stop the loop if render returned false
					if ( running !== false ) {
						requestAnimationFrame( loop, element );
						var deltaT = now - lastFrame;
						// do not render frame when deltaT is too high
						if ( deltaT < 160 ) {
							running = render( deltaT );
						}
						lastFrame = now;
					}
				}
				loop( lastFrame );
			}
			function collision(rect1, rect2) {
				if (rect1.x < rect2.x + rect2.width && rect1.x + rect1.width > rect2.x && rect1.y < rect2.y + rect2.height && rect1.height + rect1.y > rect2.y) {
					return true;
				}else{
					return false;
				}
			}
			function events() {
				document.addEventListener("keydown", function(e){
					var charCode = e.keyCode || e.which;
					packet = 0;

					if(charCode == 39 || charCode == 68) { //RIGHT
						key_right = 1;
					}else if(charCode == 37 || charCode == 65) { //LEFT
						key_left = -1;
					}else if(charCode == 32) { //JUMP
						//
					}

					db.ref("/players/" + user).set({
						packet: packet
					});
					db.ref("/players/" + user + "/packets").set({
						0: clicked,
						1: mouse[0],
						2: mouse[1]
					});
				});
				document.addEventListener("keyup", function(e){
					var charCode = e.keyCode || e.which;

					if(charCode == 39 || charCode == 68) { //RIGHT
						key_right = 0;
					}else if(charCode == 37 || charCode == 65) { //LEFT
						key_left = 0;
					}else if(charCode == 32) { //JUMP
						//
					}
				});
				
				document.addEventListener("mousedown", function(e){
					clicked = true;
					click = [e.pageX, e.pageY];
					packet = 1;
					db.ref("/players/" + user).set({
						packet: packet
					});
					db.ref("/players/" + user + "/packets").set({
						0: clicked,
						1: click[0],
						2: click[1]
					});
				});
				
				document.addEventListener("mouseup", function(){
					clicked = false;
					packet = 1;
					db.ref("/players/" + user).set({
						packet: packet
					});
					db.ref("/players/" + user + "/packets").set({
						0: clicked
					});
				});
			}
      			function load() {
				var canvas = document.getElementById("game");
        			var ctx = canvas.getContext("2d");
				canvas.width = dimension[0];
				canvas.height = dimension[1];
				loop(canvas, ctx);
				
				events();
			}
			function unload() {
				firebase.database().ref("/players/" + user).remove()
			}
			function loop(canvas, ctx) {
				animLoop(function( deltaT ) {
					ctx.clearRect(0, 0, dimension[0], dimension[1]);
					ctx.fillStyle = "lightblue";
					ctx.fillRect(0,0,dimension[0],dimension[1]);
					
					move = key_right + key_left;
					hsp = move * settings[2];
					if(vsp < 10) vsp += settings[0];
					
					db.ref("/players").on('value', function(players) {
						for(var player in players.val()) {
							if(player == user)
								continue;
							
							//PACKETS
							if(players.val()[player].packet >= 0 || players.val()[player].packet <= 1) {
								ctx.fillStyle = "gray";
								ctx.fillRect(players.val()[player].packets[1], players.val()[player].packets[2], 40, 40);
							}
						}
					});
					ctx.fillRect(mouse[0], mouse[1], 40, 40);
				}, canvas);
			}
		</script>
	</head>
	<body onload="load();" onunload="unload();">
		<canvas id="game"></canvas>
	</body>
</html>
